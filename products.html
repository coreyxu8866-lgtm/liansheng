<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品中心 - 联胜照明</title>
    <!-- 版本: v2.0 - 修复模态框交互 -->
    <!-- 添加 favicon -->
    <link rel="icon" type="image/jpeg" href="images/452e2527b5fb86f21132d0cc7d32ff92.jpg">
    <link rel="shortcut icon" type="image/jpeg" href="images/452e2527b5fb86f21132d0cc7d32ff92.jpg">
    <style>
        /* 全局基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", "PingFang SC", Arial, sans-serif;
        }
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            background: #fff !important;
        }
        /* 头部导航 */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 40px;
        }
        .logo {
            width: 150px;
            height: 70px;
        }
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .nav a {
            color: #333;
            text-decoration: none;
            font-size: 18px;
            margin: 0 20px;
            padding: 5px 0;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .nav a:hover {
            border-bottom: 2px solid #2196F3;
            color: #2196F3;
        }
        /* 当前页面高亮 */
        .nav a.active {
            border-bottom: 2px solid #2196F3;
            color: #2196F3;
            font-weight: 600;
        }
        #lang-switch {
            padding: 8px 16px;
            border: 1px solid #2196F3;
            border-radius: 4px;
            cursor: pointer;
            background: #fff;
            color: #2196F3;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        #lang-switch:hover {
            background: #2196F3;
            color: #fff;
        }
        /* 产品中心容器 */
        .product-center {
            margin: 40px 0 80px;
            padding: 0 20px;
        }
        .product-center h2 {
            font-size: 24px;
            margin-bottom: 40px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f8ff;
            font-weight: normal; /* 去掉标题加黑 */
        }
        /* 产品卡片容器 */
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }
        /* 产品卡片 */
        .product-card {
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e6f4ff;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        /* 产品图片区域 */
        .product-imgs {
            width: 100%;
            padding-bottom: 66.67%; /* 3:2宽高比 */
            position: relative;
            overflow: hidden;
            background: #f5f5f5;
        }
        .product-imgs img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.5s ease;
            opacity: 0;
        }
        .product-imgs img.active {
            opacity: 1;
        }
        .product-imgs .load-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            font-size: 14px;
        }
        /* 图片切换指示器（产品卡片内） */
        .img-indicators {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }
        .img-indicators span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .img-indicators span.active {
            background: #2196F3;
        }
        /* 产品信息区域 */
        .product-info {
            padding: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .product-info:hover {
            background: #e6f4ff;
        }
        /* 核心修改：去掉产品标题的加黑 */
        .product-info h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            font-weight: normal; /* 去掉标题加粗 */
            transition: color 0.3s ease;
        }
        .product-info:hover h3 {
            color: #2196F3;
        }
        /* 产品详情折叠/展开样式 */
        .product-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.8;
            white-space: pre-line; /* 保留文本换行 */
            /* 默认显示5行 */
            max-height: calc(1.8em * 5);
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
            position: relative;
        }
        .product-info:hover .product-desc {
            max-height: 500px; /* 展开全部 */
        }
        /* 去掉渐变提示（可选，若不需要） */
        .product-desc::after {
            display: none;
        }
        /* 尺寸图模态框 */
        .size-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.85) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 99999 !important;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .size-modal.active {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        .modal-content {
            position: relative !important;
            width: 80% !important;
            height: 80% !important;
            max-width: 1000px !important;
            max-height: 700px !important;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
        }
        .modal-img-wrapper {
            position: relative !important;
            width: 100% !important;
            height: calc(100% - 30px) !important;
            overflow: hidden !important;
            cursor: move !important;
            touch-action: none !important;
        }
        .modal-img {
            position: relative !important;
            display: block !important;
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
            margin: 0 auto !important;
            transition: transform 0.1s ease;
        }
        .modal-img-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-size: 16px;
        }
        .modal-close {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 40px;
            height: 40px;
            background: rgba(33, 150, 243, 0.9);
            color: #fff;
            font-size: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            z-index: 999999;
            pointer-events: auto;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .modal-close:hover {
            background: rgba(33, 150, 243, 1);
            transform: scale(1.1);
        }
        .modal-tip {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 14px;
            user-select: none;
        }
        .modal-indicators {
            display: none !important;
        }
        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .loading-overlay.hide {
            opacity: 0;
            pointer-events: none;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e6f4ff;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            color: #666;
        }
        /* 响应式适配 */
        @media (max-width: 768px) {
            .header {
                gap: 20px;
                justify-content: center;
            }
            .header-left {
                gap: 20px;
                justify-content: center;
            }
            .nav a {
                margin: 0 10px;
                font-size: 16px;
            }
            #lang-switch {
                margin-top: 10px;
            }
            .product-center h2 {
                font-size: 20px;
                margin-bottom: 30px;
            }
            .product-desc {
                max-height: calc(1.8em * 3); /* 移动端显示3行 */
            }
            .product-info:hover .product-desc {
                max-height: 400px;
            }
            .modal-content {
                width: 95% !important;
                height: 90% !important;
            }
            .modal-close {
                top: 5px;
                right: 5px;
                font-size: 20px;
            }
            .modal-tip {
                bottom: 5px;
                font-size: 12px;
            }
        }
        /* 模态框加载动画 */
        .modal-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }
        .modal-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e6f4ff;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .modal-loading-text {
            color: #2196F3;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在加载产品...</div>
    </div>

    <!-- 头部导航 -->
    <div class="header">
        <div class="header-left">
            <div class="logo">
                <img src="images/452e2527b5fb86f21132d0cc7d32ff92.jpg" alt="联胜照明logo">
            </div>
            <div class="nav">
                <a href="index.html" class="trans-text" data-en="Home">首页</a>
                <a href="products.html" class="active trans-text" data-en="Product Center">产品中心</a>
                <a href="contact.html" class="trans-text" data-en="Contact Us">联系我们</a>
            </div>
        </div>
        <button id="lang-switch" class="trans-text" data-en="CN">En</button>
    </div>

    <!-- 产品中心 -->
    <div class="product-center">
        <h2 class="trans-text" data-en="Product Center">产品中心</h2>
        <div id="product-list" class="product-list"></div>
    </div>

    <!-- 尺寸图模态框 -->
    <div class="size-modal" id="sizeModal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div class="modal-indicators" id="modalIndicators"></div>
            <!-- 加载动画 -->
            <div class="modal-loading" id="modalLoading">
                <div class="modal-loading-spinner"></div>
                <div class="modal-loading-text">正在加载尺寸图...</div>
            </div>
            <div class="modal-img-wrapper" id="modalImgWrapper">
                <img class="modal-img" id="modalImg" src="" alt="产品尺寸图">
                <div class="modal-img-error" id="modalImgError" style="display: none;">尺寸图加载失败</div>
            </div>
            <div class="modal-tip trans-text" data-en="Trackpad pinch to zoom / Drag to move">触摸板双指缩放 / 拖拽移动</div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentSizeImages = [];
        let currentSizeIndex = 0;
        let currentScale = 1;
        let currentX = 0;
        let currentY = 0;
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let touchStartDistance = 0;
        let touchStartScale = 1;
        const modalImg = document.getElementById('modalImg');
        const modalImgWrapper = document.getElementById('modalImgWrapper');
        let isChinese = true;
        const transElements = document.querySelectorAll('.trans-text');

        // 核心逻辑：自动加载产品（优化：使用合并数据文件 + LocalStorage）
        document.addEventListener('DOMContentLoaded', () => {
            const productListContainer = document.getElementById('product-list');
            
            // 先初始化模态框事件（重要！）
            initModalEvents();
            initLangSwitchEvent();

            // 优先从 LocalStorage 加载
            try {
                const localData = localStorage.getItem('productsData');
                if (localData) {
                    const data = JSON.parse(localData);

                    renderProducts(data, productListContainer);
                    return;
                }
            } catch (error) {

            }

            // 如果 LocalStorage 没有数据，从 JSON 文件加载
            fetch('products-data.json', { cache: 'force-cache' })
                .then(res => {
                    if (!res.ok) throw new Error(`产品数据加载失败（状态码：${res.status}）`);
                    return res.json();
                })
                .then(data => {
                    renderProducts(data, productListContainer);
                })
                .catch(err => {
                    productListContainer.innerHTML = `<div style="text-align:center; padding:40px; color:#f00;">产品数据加载失败：${err.message}</div>`;

                    hideLoading();
                });
        });
        
        // 渲染产品列表
        function renderProducts(data, productListContainer) {
            if (!data.products || !Array.isArray(data.products)) {
                throw new Error('products-data.json格式错误');
            }
            
            // 直接遍历产品数据
            data.products.forEach((product, index) => {
                try {

                    
                    // 构建图片 URL
                    let imageUrls = [];
                    
                    // 判断图片格式并构建 URL
                    if (product.images && product.images.length > 0) {
                        imageUrls = product.images.map(img => {
                            if (typeof img === 'string' && img.startsWith('data:')) {
                                return img; // Base64 直接返回
                            } else {
                                // 文件名则构建完整路径
                                return encodeURI(`images/products/${product.id}/p_png/${img}`);
                            }
                        });
                    } else {
                        // 如果没有图片，使用占位图
                        const placeholderSvg = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300">
                                <rect fill="#f0f8ff" width="400" height="300"/>
                                <text x="50%" y="45%" text-anchor="middle" fill="#999" font-size="18">暂无图片</text>
                                <text x="50%" y="60%" text-anchor="middle" fill="#ccc" font-size="14">${product.name}</text>
                            </svg>
                        `;
                        imageUrls = [`data:image/svg+xml;charset=utf-8,${encodeURIComponent(placeholderSvg)}`];
                    }
                    
                    // 直接创建产品卡片
                    const productCard = createProductCard(
                        product.name,
                        imageUrls,
                        product.description.zh,
                        product.description.en
                    );
                    productListContainer.appendChild(productCard);
                } catch (err) {
                    // 产品加载失败，静默忽略
                }
            });
            

            // 隐藏加载动画
            hideLoading();
            // 初始化懒加载
            initLazyLoad();
            // 检查是否有产品参数，如果有则滚动到对应产品
            scrollToProductFromURL();
        }

        // 隐藏加载动画
        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('hide');
                // 300ms 后完全移除
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 300);
            }
        }

        // 从 URL 参数获取产品名称并滚动到对应位置
        function scrollToProductFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const productName = urlParams.get('product');
            
            if (productName) {
                // 稍微延迟以确保 DOM 完全渲染
                setTimeout(() => {
                    const productCards = document.querySelectorAll('.product-card');
                    let targetCard = null;
                    
                    // 查找匹配的产品卡片
                    productCards.forEach((card, index) => {
                        const cardTitle = card.querySelector('h3');
                        if (cardTitle) {
                            const cardProductName = cardTitle.dataset.cn || cardTitle.textContent.trim();
                            
                            if (cardProductName === productName) {
                                targetCard = card;
                            }
                        }
                    });
                    
                    if (targetCard) {
                        // 滚动到目标产品卡片
                        targetCard.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                        
                        // 添加高亮效果
                        targetCard.style.transition = 'all 0.3s ease';
                        targetCard.style.transform = 'scale(1.05)';
                        targetCard.style.boxShadow = '0 4px 20px rgba(33, 150, 243, 0.5)';
                        
                        // 2秒后取消高亮
                        setTimeout(() => {
                            targetCard.style.transform = 'scale(1)';
                            targetCard.style.boxShadow = '';
                        }, 2000);
                    }
                }, 800); // 增加延迟时间以确保所有产品都加载完成
            }
        }

        // 加载单个产品（优化：返回Promise并行加载，但保持顺序）
        async function loadSingleProduct(productFolder, container, index) {
            try {
                const detailUrl = encodeURI(`images/products/${productFolder}/p_detail.txt`);
                const enDetailUrl = encodeURI(`images/products/${productFolder}/p_detail_en.txt`);
                
                // 优化：并行加载中英文描述和图片
                const [cnDescRes, enDescRes, images] = await Promise.all([
                    fetch(detailUrl, { cache: 'force-cache' }),
                    fetch(enDetailUrl, { cache: 'force-cache' }).catch(() => null),
                    loadProductImages(productFolder)
                ]);
                
                if (!cnDescRes.ok) throw new Error('产品信息文件不存在');
                if (images.length === 0) throw new Error('产品主图不存在');
                
                const cnDesc = await cnDescRes.text();
                const enDesc = enDescRes && enDescRes.ok ? await enDescRes.text() : cnDesc;
                
                // 临时处理：移除重复内容
                const cleanedCnDesc = cnDesc.replace(/(型号:.*?)(?=型号:.*?)/g, '').trim();
                const cleanedEnDesc = enDesc.replace(/(Model:.*?)(?=Model:.*?)/g, '').trim();
                
                const productCard = createProductCard(productFolder, images, cleanedCnDesc, cleanedEnDesc);
                return { index, card: productCard };
            } catch (err) {
                const errorCard = createErrorProductCard(productFolder, err.message);
                return { index, card: errorCard };
            }
        }

        // 加载产品主图（优化：并行检测多张图片）
        async function loadProductImages(productFolder) {
            const maxImages = 10; // 假设最多10张图片
            const images = [];
            
            // 并行检测所有可能的图片
            const checkPromises = Array.from({ length: maxImages }, (_, i) => {
                const imgIndex = i + 1;
                const rawUrl = `images/products/${productFolder}/p_png/p${imgIndex}.png`;
                const imgUrl = encodeURI(rawUrl);
                
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve({ index: imgIndex, url: imgUrl, exists: true });
                    img.onerror = () => resolve({ index: imgIndex, url: imgUrl, exists: false });
                    img.src = imgUrl;
                });
            });
            
            const results = await Promise.all(checkPromises);
            
            // 按顺序收集存在的图片
            for (const result of results) {
                if (result.exists) {
                    images.push(result.url);
                } else {
                    // 遇到不存在的图片就停止（假设图片是连续的）
                    break;
                }
            }
            
            return images;
        }

        // 懒加载单张图片
        function lazyLoadImage(img) {
            if (img && img.dataset.src && img.src !== img.dataset.src) {
                img.src = img.dataset.src;
                delete img.dataset.src;
            }
        }

        // 使用 Intersection Observer 实现懒加载
        function initLazyLoad() {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        lazyLoadImage(img);
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px' // 提前 50px 开始加载
            });

            // 监听所有带有 data-src 的图片
            document.querySelectorAll('img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });
            
            // 预加载尺寸图（产品卡片可见时）
            const cardObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const card = entry.target;
                        const productName = card.querySelector('h3').textContent;
                        // 预加载尺寸图（静默加载，不显示）
                        preloadSizeImage(productName);
                        cardObserver.unobserve(card);
                    }
                });
            }, {
                rootMargin: '200px' // 提前 200px 预加载
            });
            
            // 监听所有产品卡片
            document.querySelectorAll('.product-card').forEach(card => {
                cardObserver.observe(card);
            });
        }

        // 生成产品卡片
        function createProductCard(productName, imageUrls, cnDesc, enDesc) {
            const card = document.createElement('div');
            card.className = 'product-card';

            const imgContainer = document.createElement('div');
            imgContainer.className = 'product-imgs';
            imageUrls.forEach((url, idx) => {
                const img = document.createElement('img');
                // 懒加载优化：使用 data-src 存储真实 URL，先不加载
                if (idx === 0) {
                    // 第一张图片立即加载
                    img.src = url;
                    img.classList.add('active');
                } else {
                    // 其他图片懒加载
                    img.dataset.src = url;
                    img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"%3E%3Crect fill="%23f0f8ff" width="400" height="300"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" fill="%232196F3" font-size="16"%3E加载中...%3C/text%3E%3C/svg%3E';
                }
                img.alt = `${productName} 主图${idx+1}`;
                img.onerror = () => {
                    // 图片加载失败时显示占位图
                    const placeholderSvg = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300">
                            <rect fill="#f0f8ff" width="400" height="300"/>
                            <text x="50%" y="45%" text-anchor="middle" fill="#999" font-size="18">暂无图片</text>
                            <text x="50%" y="60%" text-anchor="middle" fill="#ccc" font-size="14">${productName}</text>
                        </svg>
                    `;
                    img.src = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(placeholderSvg)}`;
                    img.style.display = 'block';
                };
                imgContainer.appendChild(img);
            });

            // 添加图片切换时的懒加载
            const indicators = document.createElement('div');
            indicators.className = 'img-indicators';
            imageUrls.forEach((_, idx) => {
                const dot = document.createElement('span');
                if (idx === 0) dot.classList.add('active');
                dot.addEventListener('click', () => {
                    switchProductImg(imgContainer, indicators, idx);
                    // 懒加载当前切换到的图片
                    lazyLoadImage(imgContainer.querySelectorAll('img')[idx]);
                });
                indicators.appendChild(dot);
            });
            imgContainer.appendChild(indicators);

            const infoContainer = document.createElement('div');
            infoContainer.className = 'product-info';
            infoContainer.addEventListener('click', () => openSizeModal(productName));
            
            const title = document.createElement('h3');
            title.className = 'trans-text';
            title.dataset.cn = productName;
            title.dataset.en = productName.replace(/_/g, ' ').replace('LS', 'Model LS');
            title.textContent = productName;

            const desc = document.createElement('div');
            desc.className = 'product-desc trans-text';
            desc.dataset.cn = cnDesc;
            desc.dataset.en = enDesc;
            desc.textContent = cnDesc;

            infoContainer.appendChild(title);
            infoContainer.appendChild(desc);

            card.appendChild(imgContainer);
            card.appendChild(infoContainer);

            // 添加自动轮播逻辑
            if (imageUrls.length > 1) {
                let currentIndex = 0;
                let autoPlayTimer = null;
                const intervalTime = 3000 + Math.random() * 2000; // 随机 3-5 秒，避免所有卡片同步切换

                const startAutoPlay = () => {
                    if (autoPlayTimer) return;
                    autoPlayTimer = setInterval(() => {
                        currentIndex = (currentIndex + 1) % imageUrls.length;
                        switchProductImg(imgContainer, indicators, currentIndex);
                        lazyLoadImage(imgContainer.querySelectorAll('img')[currentIndex]);
                    }, intervalTime);
                };

                const stopAutoPlay = () => {
                    if (autoPlayTimer) {
                        clearInterval(autoPlayTimer);
                        autoPlayTimer = null;
                    }
                };

                // 鼠标悬停停止，离开开始
                card.addEventListener('mouseenter', stopAutoPlay);
                card.addEventListener('mouseleave', startAutoPlay);

                // 初始启动
                startAutoPlay();
                
                // 点击指示器时重置索引
                indicators.querySelectorAll('span').forEach((dot, idx) => {
                    dot.addEventListener('click', () => {
                        currentIndex = idx;
                    });
                });
            }

            return card;
        }

        // 生成错误卡片
        function createErrorProductCard(productFolder, errorMsg = '加载失败') {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <div class="product-imgs" style="display:flex;align-items:center;justify-content:center;">
                    <span class="load-error">${errorMsg}</span>
                </div>
                <div class="product-info">
                    <h3 class="trans-text" data-cn="${productFolder}" data-en="${productFolder.replace(/_/g, ' ')}">${productFolder}</h3>
                    <div class="product-desc trans-text" data-cn="请检查文件路径" data-en="Please check file path">请检查文件路径</div>
                </div>
            `;
            return card;
        }

        function updateModalImgStyle() {
            if (currentScale !== 1) {
                modalImg.style.maxWidth = 'none';
                modalImg.style.maxHeight = 'none';
            } else {
                modalImg.style.maxWidth = '100%';
                modalImg.style.maxHeight = '100%';
            }
            modalImg.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentScale})`;
        }

        function getTouchDistance(touches) {
            const x = touches[0].clientX - touches[1].clientX;
            const y = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(x * x + y * y);
        }

        function openSizeModal(productName) {
            const modal = document.getElementById('sizeModal');
            const modalImgError = document.getElementById('modalImgError');
            const modalLoading = document.getElementById('modalLoading');
            
            // 重置状态
            currentScale = 1;
            currentX = 0;
            currentY = 0;
            modalImg.style.transform = 'none';
            modalImg.style.maxWidth = '100%';
            modalImg.style.maxHeight = '100%';
            
            // 隐藏错误和图片，显示Loading
            modalImgError.style.display = 'none';
            modalImg.style.display = 'none';
            modalLoading.style.display = 'flex';
            
            // 立即打开模态框（用户看到loading）
            modal.classList.add('active');
            modal.offsetHeight; // 触发重绘

            // 后台加载尺寸图
            loadSizeImages(productName)
                .then(sizeImages => {
                    // 隐藏Loading
                    modalLoading.style.display = 'none';
                    
                    if (sizeImages.length === 0) {
                        modalImgError.style.display = 'block';
                        modalImg.style.display = 'none';
                        return;
                    }

                    currentSizeImages = sizeImages;
                    currentSizeIndex = 0;
                    modalImg.src = currentSizeImages[currentSizeIndex];
                    modalImg.onload = () => {
isDragging = false;
                        touchStartDistance = 0;
                        modalImg.style.display = 'block';
                    };
                })
                .catch(err => {
                    modalLoading.style.display = 'none';
                    modalImgError.style.display = 'block';
                    modalImg.style.display = 'none';
                });
        }

        function initModalEvents() {
            const modal = document.getElementById('sizeModal');
            const modalClose = document.querySelector('.modal-close');
            const modalImgWrapper = document.getElementById('modalImgWrapper');
            const modalImg = document.getElementById('modalImg');
            
            if (!modal || !modalClose || !modalImgWrapper || !modalImg) {
                return;
            }

            // 关闭按钮点击事件
            modalClose.addEventListener('click', (e) => {
                e.stopPropagation();
                modal.classList.remove('active');
            });
            
            // 点击模态框背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });

            // 鼠标滚轮缩放
            modalImgWrapper.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = (e.deltaY > 0 ? -0.1 : 0.1) * (Math.abs(e.deltaY) < 100 ? 2 : 1);
                currentScale = Math.max(0.5, Math.min(currentScale + delta, 3));
                updateModalImgStyle();
            });

            // 触摸开始
            modalImgWrapper.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    touchStartDistance = getTouchDistance(e.touches);
                    touchStartScale = currentScale;
                } else if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - currentX;
                    startY = e.touches[0].clientY - currentY;
                }
            });

            // 触摸移动
            modalImgWrapper.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    const currentDistance = getTouchDistance(e.touches);
                    const scaleRatio = currentDistance / touchStartDistance;
                    currentScale = Math.max(0.5, Math.min(touchStartScale * scaleRatio, 3));
                    updateModalImgStyle();
                } else if (e.touches.length === 1 && isDragging) {
                    currentX = e.touches[0].clientX - startX;
                    currentY = e.touches[0].clientY - startY;
                    updateModalImgStyle();
                }
            });

            // 触摸结束
            modalImgWrapper.addEventListener('touchend', () => {
                isDragging = false;
                touchStartDistance = 0;
                touchStartScale = 1;
            });

            // 鼠标拖拽 - 在图片上按下
            modalImgWrapper.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isDragging = true;
                startX = e.clientX - currentX;
                startY = e.clientY - currentY;
                modalImgWrapper.style.cursor = 'grabbing';
            });
            
            // 鼠标移动 - 全局监听
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                currentX = e.clientX - startX;
                currentY = e.clientY - startY;
                updateModalImgStyle();
            });
            
            // 鼠标释放 - 全局监听
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    modalImgWrapper.style.cursor = 'move';
                }
            });
        }

        function switchProductImg(imgContainer, indicators, targetIdx) {
            const imgs = imgContainer.querySelectorAll('img');
            imgs.forEach((img, idx) => {
                img.classList.toggle('active', idx === targetIdx);
            });
            const dots = indicators.querySelectorAll('span');
            dots.forEach((dot, idx) => {
                dot.classList.toggle('active', idx === targetIdx);
            });
        }

        function initLangSwitchEvent() {
            const langSwitchBtn = document.getElementById('lang-switch');
            langSwitchBtn.addEventListener('click', function() {
                isChinese = !isChinese;
                transElements.forEach(el => {
                    el.textContent = isChinese ? el.dataset.cn || el.textContent : el.dataset.en || el.textContent;
                });
                this.textContent = isChinese ? 'En' : 'CN';
            });
        }

        function loadSizeImages(productName) {
            return new Promise((resolve) => {
                // 从 LocalStorage 加载产品数据
                try {
                    const localData = localStorage.getItem('productsData');
                    if (localData) {
                        const data = JSON.parse(localData);
                        const product = data.products.find(p => p.name === productName);
                        
                        // 如果找到产品并且有详情图
                        if (product && product.sizeImage) {
                            if (typeof product.sizeImage === 'string' && product.sizeImage.startsWith('data:')) {
                                resolve([product.sizeImage]);
                            } else {
                                // 如果是文件名，则构建路径
                                resolve([encodeURI(`images/products/${product.name}/size/${product.sizeImage}`)]);
                            }
                            return;
                        }
                    }
                } catch (error) {
                    // 静默失败
                }
                
                // 如果 LocalStorage 没有，尝试从文件加载
                const images = [];
                const rawUrl = `images/products/${productName}/size/p.png`;
                const imgUrl = encodeURI(rawUrl);
                
                const img = new Image();
                img.onload = () => {
                    images.push(imgUrl);
                    resolve(images);
                };
                img.onerror = () => resolve(images);
                img.src = imgUrl;
            });
        }

        // 预加载尺寸图（静默加载，缓存到浏览器）
        function preloadSizeImage(productName) {
            const rawUrl = `images/products/${productName}/size/p.png`;
            const imgUrl = encodeURI(rawUrl);
            
            const img = new Image();
            img.src = imgUrl; // 触发加载，浏览器会缓存
            // 静默加载，不需要处理结果
        }
    </script>
</body>
</html>